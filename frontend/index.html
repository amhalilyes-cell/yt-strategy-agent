<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>YT Strategy Agent — Trouve tes vidéos x10+</title>
  <style>
    :root{
      --bg:#0f0f0f;
      --panel:#161616;
      --panel2:#111;
      --border:#222;
      --muted:#d1d1d1;
      --muted2:#a9a9a9;
      --accent:#00e5ff;
      --accent2:#0077ff;
      --danger:#ff4d4d;
      --ok:#35f28b;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    body {
      font-family: Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: #ffffff;
      line-height: 1.6;
    }
    .container {
      max-width: 980px;
      margin: auto;
      padding: 60px 20px;
    }
    h1, h2, h3 { line-height: 1.2; margin: 0; }
    h1 { font-size: 3rem; margin-bottom: 18px; }
    h2 { font-size: 2rem; margin-top: 60px; margin-bottom: 14px; }
    h3 { font-size: 1.2rem; margin-bottom: 10px; }
    p { color: var(--muted); font-size: 1.05rem; margin: 10px 0 0; }
    .highlight { color: var(--accent); }
    .card {
      background: var(--panel);
      border-radius: 14px;
      padding: 24px;
      margin-top: 18px;
      border: 1px solid rgba(255,255,255,0.04);
    }
    ul { padding-left: 20px; margin: 8px 0 0; }
    li { margin-bottom: 10px; color: var(--muted); }
    ol { margin: 8px 0 0; color: var(--muted); }
    .cta {
      margin-top: 60px;
      padding: 40px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      color: #000;
      border-radius: 16px;
      text-align: center;
    }
    .cta h2 { margin-top: 0; }
    .cta p { color: #000; }
    .cta a {
      display: inline-block;
      margin-top: 18px;
      padding: 14px 28px;
      background: #000;
      color: #fff;
      text-decoration: none;
      border-radius: 10px;
      font-weight: 700;
    }
    footer {
      margin-top: 80px;
      text-align: center;
      color: #666;
      font-size: 0.9rem;
    }

    /* ===== API tester styles ===== */
    .api {
      margin-top: 14px;
      padding: 24px;
      border-radius: 14px;
      background: var(--panel2);
      border: 1px solid var(--border);
      color: #fff;
    }
    .api label {
      display: block;
      margin-top: 10px;
      font-size: 0.95rem;
      color: var(--muted);
    }
    .api input, .api select {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid #333;
      background: #0f0f0f;
      color: #fff;
      margin-top: 8px;
      box-sizing: border-box;
      outline: none;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }
    @media (min-width: 900px){
      .row { grid-template-columns: 1fr 1fr; }
    }

    .btns {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 14px;
    }
    .api button {
      padding: 12px 18px;
      border-radius: 10px;
      border: 0;
      font-weight: 800;
      cursor: pointer;
      background: var(--accent);
      color: #000;
    }
    .api button.secondary{
      background: #1b1b1b;
      color: #fff;
      border: 1px solid #2b2b2b;
      font-weight: 700;
    }
    .api button:active { transform: translateY(1px); }

    .hint { margin-top: 8px; font-size: 0.95rem; color: var(--muted2); }
    .small { font-size: 0.9rem; color: var(--muted2); margin-top: 6px; }

    /* ===== Output ===== */
    .statusline{
      margin-top: 12px;
      font-family: var(--mono);
      font-size: 0.92rem;
      color: var(--muted2);
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid #2b2b2b;
      background:#0b0b0b;
      font-family: var(--mono);
      font-size:0.9rem;
      color:#ddd;
    }
    .pill.ok{ border-color: rgba(53,242,139,0.35); color: var(--ok); }
    .pill.bad{ border-color: rgba(255,77,77,0.35); color: var(--danger); }

    .outWrap{
      margin-top: 14px;
      padding: 16px;
      border-radius: 12px;
      background: #0b0b0b;
      border: 1px solid var(--border);
    }
    .outPre{
      margin:0;
      font-family: var(--mono);
      font-size: 0.92rem;
      color: #d1d1d1;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* ===== Blueprint UI ===== */
    .grid2{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
      margin-top:14px;
    }
    @media (min-width: 900px){
      .grid2{ grid-template-columns: 1fr 1fr; }
    }
    .kv{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kv .k{ color: var(--muted2); font-size:0.9rem; }
    .kv .v{ color:#fff; font-weight:800; }
    .hr{
      height:1px;
      background:#1d1d1d;
      margin:16px 0;
    }
    .tag{
      display:inline-block;
      padding:6px 10px;
      border-radius:999px;
      background:#0f0f0f;
      border:1px solid #2a2a2a;
      color:#e8e8e8;
      font-size:0.9rem;
      margin-right:8px;
      margin-top:8px;
    }
    .sectionTitle{
      margin-top: 8px;
      font-size: 1.05rem;
      font-weight: 900;
    }
    .muted{
      color: var(--muted2);
      font-size:0.95rem;
    }
    .bullets{
      margin:8px 0 0;
      padding-left: 18px;
    }
    .bullets li{
      margin-bottom: 8px;
      color: var(--muted);
    }
    .copyNote{
      color: var(--muted2);
      font-size: 0.9rem;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <div class="container">
    <!-- HERO -->
    <h1>
      Trouve les vidéos <span class="highlight">x10 à x30</span><br>
      avant de perdre ton temps à poster
    </h1>
    <p>
      YT Strategy Agent analyse ta chaîne YouTube business et te dit
      <strong>quoi publier</strong>, <strong>quoi répliquer</strong> et
      <strong>quoi kill</strong> pour générer plus de leads.
    </p>

    <!-- COMMENT ÇA MARCHE -->
    <h2>Comment ça marche</h2>
    <div class="card">
      <ol>
        <li>On analyse ta chaîne et ta baseline réelle</li>
        <li>On détecte tes vidéos outliers (x5, x10, x30)</li>
        <li>On génère le blueprint exact à répliquer (hook, structure, CTA)</li>
      </ol>
    </div>

    <!-- CE QUE TU OBTIENS -->
    <h2>Ce que tu obtiens</h2>
    <div class="card">
      <ul>
        <li>Détection automatique des vidéos qui surperforment</li>
        <li>Blueprints long-form orientés <strong>leads & ventes</strong></li>
        <li>Kill rules claires (quand arrêter / quand scaler)</li>
        <li>Idées de vidéos réplicables sur 14 jours</li>
        <li>Décisions basées sur la data, pas l’ego</li>
      </ul>
    </div>

    <!-- CTA -->
    <div class="cta">
      <h2>Demander un accès</h2>
      <p>
        Tu es créateur business (SaaS, Agency, OFM, Ecom) ?<br>
        Je t’analyse une vidéo et je te montre le blueprint.
      </p>
      <a href="https://tally.so/r/xxxxxx" target="_blank" rel="noreferrer">Demander un audit gratuit</a>
      <div class="small">Remplace le lien Tally par ton vrai lien.</div>
    </div>

    <!-- API TEST -->
    <h2>Tester l’API</h2>
    <div class="card api">
      <div class="hint">Ça appelle ton backend Render : <strong id="apiBaseText"></strong></div>

      <div class="row">
        <div>
          <label>Token (X-Auth-Token)</label>
          <input id="token" placeholder="colle ton token ici (ex: l31nUVaC_...)" />
          <div class="small">Astuce: colle ton token admin si tu veux éviter les 401.</div>
        </div>

        <div>
          <label>Endpoint</label>
          <select id="endpoint">
            <option value="health">GET /health (test simple)</option>
            <option value="me">GET /user/me (auth)</option>
            <option value="blueprint_v2">POST /playbook/blueprint/v2 (blueprint lisible)</option>
            <option value="premium_pack">POST /premium/pack (premium)</option>
          </select>

          <label style="margin-top:10px;">Video ID (YouTube)</label>
          <input id="videoId" value="nV6OzZ6ToXE" />
          <div class="small">⚠️ Pour blueprint/premium : la vidéo doit exister en DB (trend/bootstrap d’abord).</div>
        </div>
      </div>

      <div class="btns">
        <button id="run">Tester</button>
        <button id="copyMd" class="secondary" type="button">Copier en Markdown</button>
        <button id="toggleView" class="secondary" type="button">Afficher JSON brut</button>
      </div>

      <div class="statusline" id="statusline">
        <span class="pill" id="pill">READY</span>
        <span id="statusText" class="muted">—</span>
      </div>

      <!-- rendu lisible -->
      <div id="pretty" class="outWrap" style="display:none;"></div>

      <!-- JSON brut -->
      <div id="rawWrap" class="outWrap">
        <pre id="out" class="outPre">Résultat ici…</pre>
      </div>

      <div class="copyNote" id="copyNote" style="display:none;"></div>
    </div>

    <footer>
      © 2026 — YT Strategy Agent
    </footer>
  </div>

  <script>
    // ✅ Change juste ça si tu changes Render
    const API_BASE = "https://yt-strategy-agent.onrender.com";
    document.getElementById("apiBaseText").textContent = API_BASE;

    const btn = document.getElementById("run");
    const out = document.getElementById("out");

    const pretty = document.getElementById("pretty");
    const rawWrap = document.getElementById("rawWrap");
    const toggleBtn = document.getElementById("toggleView");
    const copyBtn = document.getElementById("copyMd");
    const copyNote = document.getElementById("copyNote");

    const pill = document.getElementById("pill");
    const statusText = document.getElementById("statusText");

    let lastJson = null;
    let lastMd = "";

    function setStatus(ok, text){
      pill.classList.remove("ok","bad");
      if (ok === true) { pill.classList.add("ok"); pill.textContent = "OK"; }
      else if (ok === false) { pill.classList.add("bad"); pill.textContent = "ERROR"; }
      else { pill.textContent = "READY"; }
      statusText.textContent = text || "—";
    }

    function esc(s){
      return String(s ?? "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;");
    }
    function arr(x){ return Array.isArray(x) ? x : []; }

    function unwrapBlueprint(obj){
      if (!obj || typeof obj !== "object") return obj;
      if (obj.blueprint && typeof obj.blueprint === "object") return obj.blueprint;
      if (obj.data && typeof obj.data === "object") return obj.data;
      return obj;
    }

    function toMarkdown(bpRaw){
      const bp = unwrapBlueprint(bpRaw);
      if (!bp || typeof bp !== "object") return "";

      const title = bp.title || "(sans titre)";
      const format = bp.format || bp.format_type || bp.type || "";
      const duration = Array.isArray(bp.duration_target_seconds) ? bp.duration_target_seconds.join("–") : "";

      const hook = bp.hook_structure || {};
      const posting = bp.posting_strategy || {};
      const kill = bp.kill_conditions || {};
      const ideas = arr(bp.ideas);
      const content = arr(bp.content_structure);

      let md = `# Blueprint — ${title}\n\n`;
      if (format || duration){
        md += `**Format:** ${format || "-"}  \n`;
        md += `**Durée cible:** ${duration ? duration + "s" : "-"}\n\n`;
      }

      md += `## Hook\n`;
      if (hook.type) md += `- Type: ${hook.type}\n`;
      if (hook.first_1s_goal) md += `- Goal 1s: ${hook.first_1s_goal}\n`;
      arr(hook.avoid).forEach(a => md += `- À éviter: ${a}\n`);
      const ex = arr(hook.examples || hook.examples_fr);
      if (ex.length){
        md += `\n**Exemples:**\n`;
        ex.forEach(e => md += `- ${e}\n`);
      }

      md += `\n## Structure\n`;
      content.forEach(s => md += `- ${s}\n`);

      md += `\n## Posting\n`;
      Object.entries(posting).forEach(([k,v]) => {
        md += `- ${k}: ${typeof v === "string" ? v : JSON.stringify(v)}\n`;
      });

      md += `\n## Kill rules\n`;
      Object.entries(kill).forEach(([k,v]) => {
        md += `- ${k}: ${String(v)}\n`;
      });

      if (ideas.length){
        md += `\n## Idées\n`;
        ideas.forEach(it => {
          if (typeof it === "string") { md += `- ${it}\n`; return; }
          const idea = it.idea || it.title || "(idée)";
          md += `- **${idea}**\n`;
          if (it.hook_template) md += `  - Hook: ${it.hook_template}\n`;
          if (Array.isArray(it.hook_variations)) it.hook_variations.forEach(h => md += `  - Hook var: ${h}\n`);
          if (it.note) md += `  - Note: ${it.note}\n`;
        });
      }

      return md.trim();
    }

    function renderPretty(bpRaw){
      const bp = unwrapBlueprint(bpRaw);
      pretty.innerHTML = "";
      copyNote.style.display = "none";
      copyNote.textContent = "";

      if (!bp || typeof bp !== "object"){
        pretty.innerHTML = `<pre class="outPre">Impossible d'afficher (réponse non JSON).</pre>`;
        return;
      }

      const title = bp.title || "(sans titre)";
      const format = bp.format || "-";
      const duration = Array.isArray(bp.duration_target_seconds) ? bp.duration_target_seconds.join("–") + "s" : "-";
      const confidence = bp.confidence || bp.confidence_level || "-";

      const hook = bp.hook_structure || {};
      const content = arr(bp.content_structure);
      const posting = bp.posting_strategy || {};
      const kill = bp.kill_conditions || {};
      const ideas = arr(bp.ideas);

      const shift = (bp.format_shift || {});
      const shiftDetected = !!shift.detected;
      const shiftDims = arr(shift.dimensions);

      const hookAvoid = arr(hook.avoid);
      const hookExamples = arr(hook.examples || hook.examples_fr);

      const tags = [];
      if (bp.vertical) tags.push(`vertical: ${bp.vertical}`);
      if (bp.goal) tags.push(`goal: ${bp.goal}`);
      if (bp.language) tags.push(`lang: ${bp.language}`);
      if (shiftDetected) tags.push(`⚠ format shift`);

      pretty.innerHTML = `
        <div class="grid2">
          <div class="card" style="margin-top:0;background:#0b0b0b;border:1px solid var(--border);">
            <div class="kv">
              <div class="k">Titre</div>
              <div class="v">${esc(title)}</div>
            </div>
            <div style="margin-top:10px;">
              <span class="tag">format: ${esc(format)}</span>
              <span class="tag">durée: ${esc(duration)}</span>
              <span class="tag">confidence: ${esc(confidence)}</span>
              ${tags.map(t => `<span class="tag">${esc(t)}</span>`).join("")}
            </div>
          </div>

          <div class="card" style="margin-top:0;background:#0b0b0b;border:1px solid var(--border);">
            <div class="sectionTitle">Posting strategy</div>
            <div class="muted">Règles simples à suivre</div>
            <ul class="bullets">
              ${Object.keys(posting).length ? Object.entries(posting).map(([k,v]) =>
                `<li><strong>${esc(k)}:</strong> ${esc(typeof v === "string" ? v : JSON.stringify(v))}</li>`
              ).join("") : `<li class="muted">—</li>`}
            </ul>
          </div>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div class="card" style="margin-top:0;background:#0b0b0b;border:1px solid var(--border);">
            <div class="sectionTitle">Hook</div>
            <div class="muted">Structure et exemples</div>
            <ul class="bullets">
              ${hook.type ? `<li><strong>Type:</strong> ${esc(hook.type)}</li>` : ""}
              ${hook.first_1s_goal ? `<li><strong>Goal 1s:</strong> ${esc(hook.first_1s_goal)}</li>` : ""}
              ${hookAvoid.length ? `<li><strong>À éviter:</strong> ${esc(hookAvoid.join(", "))}</li>` : ""}
            </ul>
            ${hookExamples.length ? `
              <div style="margin-top:12px;" class="muted"><strong>Exemples</strong></div>
              <ul class="bullets">
                ${hookExamples.slice(0,6).map(x => `<li>${esc(x)}</li>`).join("")}
              </ul>
            ` : `<div class="muted" style="margin-top:10px;">(Pas d’exemples)</div>`}
          </div>

          <div class="card" style="margin-top:0;background:#0b0b0b;border:1px solid var(--border);">
            <div class="sectionTitle">Kill rules</div>
            <div class="muted">Quand tuer / re-edit</div>
            <ul class="bullets">
              ${Object.keys(kill).length ? Object.entries(kill).map(([k,v]) =>
                `<li><strong>${esc(k)}:</strong> ${esc(String(v))}</li>`
              ).join("") : `<li class="muted">—</li>`}
            </ul>
          </div>
        </div>

        <div class="hr"></div>

        <div class="card" style="margin-top:0;background:#0b0b0b;border:1px solid var(--border);">
          <div class="sectionTitle">Content structure</div>
          <div class="muted">Plan de la vidéo</div>
          <ul class="bullets">
            ${content.length ? content.map(s => `<li>${esc(s)}</li>`).join("") : `<li class="muted">—</li>`}
          </ul>
        </div>

        <div class="hr"></div>

        <div class="grid2">
          <div class="card" style="margin-top:0;background:#0b0b0b;border:1px solid var(--border);">
            <div class="sectionTitle">Idées</div>
            <div class="muted">Angles réplicables</div>
            <ul class="bullets">
              ${ideas.length ? ideas.slice(0,10).map(it => {
                if (typeof it === "string") return `<li>${esc(it)}</li>`;
                const idea = it.idea || it.title || "(idée)";
                const hookT = it.hook_template ? `<div class="muted" style="margin-top:6px;">Hook: <span style="color:#eaeaea">${esc(it.hook_template)}</span></div>` : "";
                const note = it.note ? `<div class="muted" style="margin-top:6px;">Note: ${esc(it.note)}</div>` : "";
                const hv = Array.isArray(it.hook_variations) ? it.hook_variations.slice(0,3).map(h => `<div class="muted" style="margin-top:6px;">Var: ${esc(h)}</div>`).join("") : "";
                return `<li><strong>${esc(idea)}</strong>${hookT}${hv}${note}</li>`;
              }).join("") : `<li class="muted">—</li>`}
            </ul>
          </div>

          <div class="card" style="margin-top:0;background:#0b0b0b;border:1px solid var(--border);">
            <div class="sectionTitle">Format shift</div>
            <div class="muted">Détection</div>
            <ul class="bullets">
              <li><strong>Detected:</strong> ${shiftDetected ? "true" : "false"}</li>
              <li><strong>Dimensions:</strong> ${shiftDims.length ? esc(shiftDims.join(", ")) : "—"}</li>
            </ul>
          </div>
        </div>
      `;
    }

    function showRaw(){
      rawWrap.style.display = "block";
      pretty.style.display = "none";
      out.textContent = JSON.stringify(lastJson ?? {}, null, 2);
      toggleBtn.textContent = "Afficher rendu lisible";
    }

    function showPretty(){
      rawWrap.style.display = "none";
      pretty.style.display = "block";
      toggleBtn.textContent = "Afficher JSON brut";
    }

    toggleBtn.onclick = () => {
      if (rawWrap.style.display === "none") showRaw();
      else showPretty();
    };

    copyBtn.onclick = async () => {
      if (!lastMd) {
        copyNote.style.display = "block";
        copyNote.textContent = "❌ Rien à copier (génère d’abord un blueprint).";
        return;
      }
      try{
        await navigator.clipboard.writeText(lastMd);
        copyNote.style.display = "block";
        copyNote.textContent = "✅ Copié !";
      }catch(e){
        copyNote.style.display = "block";
        copyNote.textContent = "❌ Impossible de copier (autorisation navigateur).";
      }
    };

    async function readJsonOrText(r){
      const text = await r.text();
      try { return { json: JSON.parse(text), text }; }
      catch(e){ return { json: null, text }; }
    }

    btn.onclick = async () => {
      const token = document.getElementById("token").value.trim();
      const endpoint = document.getElementById("endpoint").value;
      const videoId = document.getElementById("videoId").value.trim() || "nV6OzZ6ToXE";

      setStatus(null, "Loading...");
      lastJson = null;
      lastMd = "";
      copyNote.style.display = "none";

      rawWrap.style.display = "block";
      pretty.style.display = "none";
      toggleBtn.textContent = "Afficher rendu lisible";
      out.textContent = "Loading...";

      try {
        if (endpoint === "health") {
          const r = await fetch(API_BASE + "/health");
          const { json, text } = await readJsonOrText(r);
          lastJson = json || { raw: text };
          setStatus(r.ok, `GET /health — HTTP ${r.status}`);
          showRaw();
          return;
        }

        if (!token) {
          setStatus(false, "Token manquant (X-Auth-Token).");
          lastJson = { error: "Token manquant (X-Auth-Token)." };
          showRaw();
          return;
        }

        if (endpoint === "me") {
          const r = await fetch(API_BASE + "/user/me", { headers: { "X-Auth-Token": token } });
          const { json, text } = await readJsonOrText(r);
          lastJson = json || { raw: text };
          setStatus(r.ok, `GET /user/me — HTTP ${r.status}`);
          showRaw();
          return;
        }

        if (endpoint === "blueprint_v2") {
          const r = await fetch(API_BASE + "/playbook/blueprint/v2", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Auth-Token": token },
            body: JSON.stringify({
              video_id: videoId,
              baseline_lookback: 30,
              vertical: "saas",
              goal: "leads",
              language: "fr"
            })
          });

          const { json, text } = await readJsonOrText(r);
          lastJson = json || { raw: text };

          if (!r.ok) {
            setStatus(false, `POST /playbook/blueprint/v2 — HTTP ${r.status}`);
            showRaw();
            return;
          }

          setStatus(true, `POST /playbook/blueprint/v2 — HTTP ${r.status}`);

          if (json && typeof json === "object") {
            lastMd = toMarkdown(json);
            renderPretty(json);
            showPretty();
          } else {
            showRaw();
          }
          return;
        }

        if (endpoint === "premium_pack") {
          const r = await fetch(API_BASE + "/premium/pack", {
            method: "POST",
            headers: { "Content-Type": "application/json", "X-Auth-Token": token },
            body: JSON.stringify({
              seed_video_id: videoId,
              timeframe_days: 30,
              baseline_lookback: 30,
              business: {
                vertical: "saas",
                goal: "leads",
                audience: "founders",
                language: "fr",
                region: "FR"
              },
              cadence: { shorts_per_week: 5, longs_per_month: 4 }
            })
          });

          const { json, text } = await readJsonOrText(r);
          lastJson = json || { raw: text };

          if (!r.ok) {
            setStatus(false, `POST /premium/pack — HTTP ${r.status}`);
            showRaw();
            return;
          }

          setStatus(true, `POST /premium/pack — HTTP ${r.status}`);
          showRaw(); // premium pack = gros JSON, on laisse brut
          return;
        }

      } catch (e) {
        setStatus(false, "Erreur réseau / CORS");
        lastJson = { error: String(e && e.message ? e.message : e) };
        showRaw();
      }
    };
  </script>

</body>
</html>
